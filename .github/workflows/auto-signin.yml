name: NodeLoc Auto Sign-in

on:
  workflow_dispatch:
  schedule:
    # 每天 08:00 UTC 运行，可按需修改
    - cron: '0 8 * * *'

# 环境变量配置
env:
  # Telegram 推送配置（可选）
  TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
  TG_USER_ID: ${{ secrets.TG_USER_ID }}
  # Gotify 推送配置（可选）
  GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
  GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
  # 浏览功能配置（可选）
  BROWSE_ENABLED: ${{ vars.BROWSE_ENABLED || 'true' }}
  LIKE_PROB: ${{ vars.LIKE_PROB || '0.3' }}
  CLICK_COUNT: ${{ vars.CLICK_COUNT || '10' }}

jobs:
  signin:
    runs-on: ubuntu-latest

    # 指定工作目录为 nodeloc 子文件夹
    defaults:
      run:
        working-directory: nodeloc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system packages
        working-directory: .
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            wget gnupg ca-certificates unzip fonts-liberation \
            libatk1.0-0 libatk-bridge2.0-0 libcups2 libdbus-1-3 libexpat1 \
            libfontconfig1 libgbm1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 \
            libpango-1.0-0 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
            libxdamage1 libxext6 libxfixes3 libxi6 libxinerama1 libxrandr2 libxrender1 \
            libxss1 libxtst6 lsb-release xdg-utils jq || true

      - name: Install Chrome for Testing (with matching ChromeDriver)
        working-directory: .
        run: |
          set -euo pipefail
          
          # 使用 Chrome for Testing 的 JSON API 获取最新稳定版信息
          echo "Fetching latest Chrome for Testing version..."
          JSON_URL="https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
          
          # 获取 Stable 版本的下载链接
          CHROME_URL=$(curl -s "$JSON_URL" | jq -r '.channels.Stable.downloads.chrome[] | select(.platform=="linux64") | .url')
          CHROMEDRIVER_URL=$(curl -s "$JSON_URL" | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform=="linux64") | .url')
          VERSION=$(curl -s "$JSON_URL" | jq -r '.channels.Stable.version')
          
          echo "Installing Chrome for Testing version: $VERSION"
          echo "Chrome URL: $CHROME_URL"
          echo "ChromeDriver URL: $CHROMEDRIVER_URL"
          
          # 下载并安装 Chrome
          wget -q -O chrome-linux64.zip "$CHROME_URL"
          unzip -q chrome-linux64.zip
          sudo mv chrome-linux64 /opt/chrome
          sudo ln -sf /opt/chrome/chrome /usr/local/bin/google-chrome
          sudo chmod +x /opt/chrome/chrome
          
          # 下载并安装 ChromeDriver
          wget -q -O chromedriver-linux64.zip "$CHROMEDRIVER_URL"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver
          
          # 清理下载文件
          rm -rf chrome-linux64.zip chromedriver-linux64.zip chromedriver-linux64
          
          echo "Installed versions:"
          /opt/chrome/chrome --version || echo "Chrome version check failed"
          chromedriver --version || echo "ChromeDriver version check failed"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('nodeloc/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run NodeLoc sign-in
        env:
          NL_COOKIE: ${{ secrets.NL_COOKIE }}
          # 告诉 undetected_chromedriver 使用我们安装的 Chrome
          CHROME_EXECUTABLE_PATH: /opt/chrome/chrome
        run: |
          set -euo pipefail
          python main.py
